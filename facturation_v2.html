<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PF Solidaire - Facturation V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #10b981; --secondary: #3b82f6; --dark: #1e293b; --light: #f8fafc; --gray: #64748b; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        .brand { color: var(--primary); font-size: 1.4rem; font-weight: 800; margin-bottom: 30px; display:flex; align-items:center; gap:10px; }
        .nav-link { display: flex; align-items: center; gap: 10px; padding: 12px; color: var(--gray); text-decoration: none; border-radius: 8px; margin-bottom: 5px; }
        .nav-link:hover, .nav-link.active { background: #ecfdf5; color: #059669; }
        
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; color: white; display:flex; align-items:center; gap:8px; }
        .btn-green { background: var(--primary); }
        .btn-blue { background: var(--secondary); }
        .btn-red { background: #ef4444; }
        
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* FACTURE EDITOR STYLE */
        .facture-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        input, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 5px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: var(--gray); font-size: 0.85rem; padding: 10px; border-bottom: 2px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        .total-zone { background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .total-line { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .grand-total { font-size: 1.2rem; font-weight: bold; color: var(--dark); border-top: 1px solid #cbd5e1; padding-top: 10px; margin-top: 5px; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .facture-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <img id="logo-source" src="Logo.png" style="display: none;" crossorigin="anonymous">

    <nav class="sidebar">
        <div class="brand"><i class="fas fa-file-invoice"></i> FACTURATION</div>
        <a href="index.html" class="nav-link"><i class="fas fa-arrow-left"></i> Retour ERP</a>
        <a href="#" class="nav-link active"><i class="fas fa-edit"></i> Nouvelle Facture</a>
    </nav>

    <main class="main-content">
        <div class="header-bar">
            <h1>Éditeur de Facture</h1>
            <button onclick="window.exporterExcel()" class="btn btn-green" style="background-color:#059669;">
                <i class="fas fa-file-excel"></i> EXPORT COMPTABLE
            </button>
        </div>

        <div class="facture-grid">
            <div class="card">
                <h3><i class="fas fa-list"></i> Prestations & Articles</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table id="table-lignes">
                        <thead>
                            <tr>
                                <th style="width:50%">Désignation</th>
                                <th style="width:10%">Qte</th>
                                <th style="width:15%">Prix U.</th>
                                <th style="width:10%">TVA%</th>
                                <th style="width:10%">Total</th>
                                <th style="width:5%"></th>
                            </tr>
                        </thead>
                        <tbody id="tbody-lignes">
                            </tbody>
                    </table>
                </div>
                <button onclick="window.ajouterLigne()" class="btn btn-blue" style="margin-top:10px; width:100%; justify-content:center;">+ Ajouter une ligne</button>
            </div>

            <div class="card">
                <h3><i class="fas fa-user"></i> Client & Dossier</h3>
                <label>Sélectionner un Dossier (Optionnel)</label>
                <select id="select-dossier" onchange="window.remplirClient()"><option value="">-- Client Libre --</option></select>
                
                <label style="margin-top:10px; display:block;">Client (Facturé à)</label>
                <input id="cli_nom" placeholder="Nom complet ou Société">
                <input id="cli_adresse" placeholder="Adresse complète">
                
                <label style="margin-top:10px; display:block;">Concerne (Défunt)</label>
                <input id="defunt_nom" placeholder="Nom du défunt (Optionnel)">

                <div class="total-zone">
                    <div class="total-line"><span>Total HT</span><span id="txt-ht">0.00 €</span></div>
                    <div class="total-line"><span>Total TVA</span><span id="txt-tva">0.00 €</span></div>
                    <div class="total-line grand-total"><span>NET À PAYER</span><span id="txt-ttc">0.00 €</span></div>
                </div>

                <button onclick="window.saveFacture()" class="btn btn-green" style="width:100%; margin-top:20px; justify-content:center;">
                    <i class="fas fa-save"></i> ENREGISTRER & IMPRIMER
                </button>
            </div>
        </div>

        <div class="card">
            <h3><i class="fas fa-history"></i> Historique des Factures</h3>
            <table>
                <thead><tr><th>N°</th><th>Date</th><th>Client</th><th>Montant TTC</th><th>Actions</th></tr></thead>
                <tbody id="historique-body"></tbody>
            </table>
        </div>
    </main>

    <script type="module">
        import { db, collection, addDoc, getDocs, query, orderBy, doc, deleteDoc, updateDoc } from "./js/config.js";

        // Variables Globales
        let lignesFacture = [];
        let dossiersCache = [];

        // 1. CHARGEMENT INITIAL
        window.addEventListener('DOMContentLoaded', async () => {
            await chargerDossiersDropdown();
            await chargerHistorique();
            window.ajouterLigne(); // Une ligne vide au début
        });

        // 2. LOGIQUE FACTURATION (RESTAURÉE)
        window.ajouterLigne = function() {
            const tbody = document.getElementById('tbody-lignes');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="l-nom" placeholder="Prestation..." oninput="window.calculTotaux()"></td>
                <td><input type="number" class="l-qte" value="1" oninput="window.calculTotaux()"></td>
                <td><input type="number" class="l-prix" value="0" oninput="window.calculTotaux()"></td>
                <td><select class="l-tva" onchange="window.calculTotaux()"><option value="20">20%</option><option value="10">10%</option><option value="0">0%</option></select></td>
                <td class="l-total" style="font-weight:bold;">0.00</td>
                <td><button onclick="this.closest('tr').remove(); window.calculTotaux()" style="color:red; background:none; border:none; cursor:pointer;">X</button></td>
            `;
            tbody.appendChild(tr);
        };

        window.calculTotaux = function() {
            let totalHT = 0;
            let totalTVA = 0;
            const rows = document.querySelectorAll('#tbody-lignes tr');
            
            lignesFacture = []; // Reset du tableau de données

            rows.forEach(row => {
                const nom = row.querySelector('.l-nom').value;
                const qte = parseFloat(row.querySelector('.l-qte').value) || 0;
                const prix = parseFloat(row.querySelector('.l-prix').value) || 0;
                const tvaRate = parseFloat(row.querySelector('.l-tva').value) || 0;
                
                const rowHT = qte * prix;
                const rowTVA = rowHT * (tvaRate / 100);
                
                row.querySelector('.l-total').innerText = (rowHT + rowTVA).toFixed(2);
                
                totalHT += rowHT;
                totalTVA += rowTVA;

                if(nom) {
                    lignesFacture.push({ nom, qte, prix, tva: tvaRate, total: rowHT + rowTVA });
                }
            });

            document.getElementById('txt-ht').innerText = totalHT.toFixed(2) + " €";
            document.getElementById('txt-tva').innerText = totalTVA.toFixed(2) + " €";
            document.getElementById('txt-ttc').innerText = (totalHT + totalTVA).toFixed(2) + " €";
        };

        // 3. CHARGEMENT DOSSIERS
        async function chargerDossiersDropdown() {
            const sel = document.getElementById('select-dossier');
            try {
                const q = query(collection(db, "dossiers_admin"), orderBy("date_creation", "desc"));
                const snap = await getDocs(q);
                dossiersCache = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    dossiersCache.push(d);
                    const opt = document.createElement('option');
                    opt.value = dossiersCache.length - 1; // Index
                    opt.text = `${d.mandant?.nom || 'Client'} (Déf: ${d.defunt?.nom || '?'})`;
                    sel.appendChild(opt);
                });
            } catch(e) { console.error(e); }
        }

        window.remplirClient = function() {
            const idx = document.getElementById('select-dossier').value;
            if(idx !== "") {
                const d = dossiersCache[idx];
                document.getElementById('cli_nom').value = (d.mandant?.civility||"") + " " + (d.mandant?.nom||"");
                document.getElementById('cli_adresse').value = d.mandant?.adresse || "";
                document.getElementById('defunt_nom').value = (d.defunt?.nom || "") + " " + (d.defunt?.prenom || "");
            }
        }

        // 4. SAUVEGARDE & PDF
        window.saveFacture = async function() {
            const client = document.getElementById('cli_nom').value;
            if(!client || lignesFacture.length === 0) return alert("Veuillez remplir le client et au moins une ligne.");

            if(!confirm("Valider cette facture ?")) return;

            const ht = parseFloat(document.getElementById('txt-ht').innerText);
            const tva = parseFloat(document.getElementById('txt-tva').innerText);
            const ttc = parseFloat(document.getElementById('txt-ttc').innerText);
            
            const numFacture = "F-" + new Date().getFullYear() + "-" + Math.floor(Math.random() * 10000);

            const factureData = {
                numero: numFacture,
                date_creation: new Date().toISOString(),
                client: { nom: client, adresse: document.getElementById('cli_adresse').value },
                defunt: { nom: document.getElementById('defunt_nom').value },
                lignes: lignesFacture,
                total_ht: ht, total_tva: tva, total_ttc: ttc,
                statut: "Émise"
            };

            try {
                await addDoc(collection(db, "factures_v2"), factureData);
                genererPDF(factureData);
                alert("✅ Facture enregistrée !");
                window.location.reload();
            } catch(e) { alert("Erreur : " + e.message); }
        };

        function genererPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-tête (Simulé)
            doc.setFontSize(18); doc.text("FACTURE " + data.numero, 150, 20);
            doc.setFontSize(12); doc.text("PF SOLIDAIRE", 20, 20);
            doc.setFontSize(10); doc.text("32 Bd Léon Jean Grégory, Thuir", 20, 25);
            
            // Client
            doc.text("CLIENT :", 120, 50);
            doc.setFont("helvetica", "bold");
            doc.text(data.client.nom, 120, 55);
            doc.setFont("helvetica", "normal");
            doc.text(data.client.adresse || "", 120, 60);

            // Tableau
            const rows = data.lignes.map(l => [l.nom, l.qte, l.prix.toFixed(2), l.tva+"%", l.total.toFixed(2)]);
            doc.autoTable({
                startY: 80,
                head: [['Désignation', 'Qte', 'PU', 'TVA', 'Total TTC']],
                body: rows,
            });

            // Totaux
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total HT : ${data.total_ht.toFixed(2)} €`, 150, finalY);
            doc.text(`Total TVA : ${data.total_tva.toFixed(2)} €`, 150, finalY + 7);
            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text(`NET À PAYER : ${data.total_ttc.toFixed(2)} €`, 130, finalY + 15);

            doc.save(`Facture_${data.numero}.pdf`);
        }

        // 5. HISTORIQUE
        async function chargerHistorique() {
            const tbody = document.getElementById('historique-body');
            const q = query(collection(db, "factures_v2"), orderBy("date_creation", "desc"));
            const snap = await getDocs(q);
            
            snap.forEach(docSnap => {
                const d = docSnap.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${d.numero}</td>
                    <td>${new Date(d.date_creation).toLocaleDateString()}</td>
                    <td>${d.client.nom}</td>
                    <td><strong>${d.total_ttc.toFixed(2)} €</strong></td>
                    <td>
                        <button class="btn-icon" onclick="alert('Réimpression bientôt dispo')"><i class="fas fa-print"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 6. MODULE EXPORT EXCEL (LE NOUVEAU)
        window.exporterExcel = async function() {
            if(!confirm("Télécharger le journal des ventes (Excel) ?")) return;

            let csv = "N° FACTURE;DATE;CLIENT;DEFUNT;TOTAL HT;TVA;TOTAL TTC;STATUT\n";

            try {
                const q = query(collection(db, "factures_v2"), orderBy("numero", "desc"));
                const snap = await getDocs(q);

                snap.forEach(doc => {
                    const d = doc.data();
                    const date = new Date(d.date_creation).toLocaleDateString();
                    const ht = (d.total_ht || 0).toFixed(2).replace('.', ',');
                    const tva = (d.total_tva || 0).toFixed(2).replace('.', ',');
                    const ttc = (d.total_ttc || 0).toFixed(2).replace('.', ',');
                    
                    csv += `${d.numero};${date};${d.client.nom};${d.defunt?.nom||''};${ht};${tva};${ttc};${d.statut||'Emise'}\n`;
                });

                const link = document.createElement("a");
                link.href = 'data:text/csv;charset=utf-8,%EF%BB%BF' + encodeURI(csv);
                link.download = "Journal_Ventes.csv";
                link.click();
            } catch(e) { alert("Erreur export : " + e.message); }
        };

    </script>
</body>
</html>
