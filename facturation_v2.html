<script>
        // --- 1. GESTION DE L'HEURE ---
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
            const dateString = now.toLocaleDateString('fr-FR', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            
            const elTime = document.getElementById('header-time');
            const elDate = document.getElementById('header-date');
            
            if(elTime) elTime.innerText = timeString;
            if(elDate) elDate.innerText = dateString;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- 2. GESTION GED (PLAN B - BASE64) ---
        window.current_pieces_jointes = [];

        window.ajouterPieceJointe = function() {
            const input = document.getElementById('ged_input_file');
            const nameInput = document.getElementById('ged_file_name');
            
            if (input.files.length === 0) return alert("Choisissez un fichier !");
            if (!nameInput.value) return alert("Donnez un nom au document !");
            
            const file = input.files[0];

            if (file.size > 800 * 1024) {
                return alert("⚠️ FICHIER TROP LOURD !\nLa version gratuite limite la taille. Essayez une image plus petite ou un PDF léger.");
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                if (!window.current_pieces_jointes) window.current_pieces_jointes = [];
                
                window.current_pieces_jointes.push({
                    nom: nameInput.value,
                    type: file.type,
                    data: base64String,
                    date: new Date().toLocaleDateString()
                });

                input.value = "";
                nameInput.value = "";
                window.afficherPiecesJointes();
            };
            reader.readAsDataURL(file);
        };

        window.afficherPiecesJointes = function() {
            const container = document.getElementById('liste_pieces_jointes');
            container.innerHTML = "";

            if (!window.current_pieces_jointes || window.current_pieces_jointes.length === 0) {
                container.innerHTML = '<div style="color:#94a3b8; font-style:italic;">Aucun document joint.</div>';
                return;
            }

            window.current_pieces_jointes.forEach((doc, index) => {
                const div = document.createElement('div');
                div.style = "background:white; padding:10px; border-radius:6px; border:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;";
                
                let icon = doc.type.includes('pdf') ? '<i class="fas fa-file-pdf" style="color:red;"></i>' : '<i class="fas fa-file-image" style="color:blue;"></i>';

                div.innerHTML = `
                    <div style="display:flex; gap:10px; align-items:center;">
                        ${icon} <strong>${doc.nom}</strong> <small>(${doc.date})</small>
                    </div>
                    <div>
                        <button onclick="window.voirDocument(${index})" style="background:#3b82f6; color:white; border:none; padding:5px 10px; border-radius:4px; margin-right:5px; cursor:pointer;"><i class="fas fa-eye"></i></button>
                        <button onclick="window.supprimerDocument(${index})" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        };

        window.voirDocument = function(index) {
            const doc = window.current_pieces_jointes[index];
            const win = window.open();
            win.document.write(`<iframe src="${doc.data}" style="border:0; width:100%; height:100%;" allowfullscreen></iframe>`);
        };

        window.supprimerDocument = function(index) {
            if(confirm("Supprimer ce document ?")) {
                window.current_pieces_jointes.splice(index, 1);
                window.afficherPiecesJointes();
            }
        };

        // --- 3. GESTION MENU MOBILE (BURGER) & SIDEBAR RÉTRACTABLE ---
        window.toggleMobileMenu = function() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const btnIcon = document.querySelector('#mobile-menu-btn i');
            
            // Si on est sur mobile
            if (window.innerWidth < 768) {
                sidebar.classList.toggle('mobile-open');
                if (sidebar.classList.contains('mobile-open')) {
                    overlay.style.display = 'block';
                    btnIcon.classList.remove('fa-bars');
                    btnIcon.classList.add('fa-times');
                } else {
                    overlay.style.display = 'none';
                    btnIcon.classList.remove('fa-times');
                    btnIcon.classList.add('fa-bars');
                }
            } else {
                // Si on est sur PC : mode réduit
                sidebar.classList.toggle('collapsed');
            }
        };

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if(window.innerWidth < 768) window.toggleMobileMenu();
            });
        });

        // --- 4. RÉCEPTION DU LIEN FACTURE (RECHERCHE AUTO) ---
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const recherche = params.get('recherche');

            if(recherche) {
                // 1. Ouvrir l'onglet "Base Clients"
                window.showSection('base');
                
                // 2. Attendre que la liste charge (Firebase) puis filtrer
                setTimeout(() => {
                    const input = document.getElementById('search-client');
                    if(input) {
                        input.value = recherche;
                        // Déclencher le filtre visuel
                        const term = recherche.toLowerCase();
                        const rows = document.querySelectorAll('#clients-table-body tr');
                        let found = false;
                        rows.forEach(row => {
                            if(row.textContent.toLowerCase().includes(term)) {
                                row.style.display = '';
                                found = true;
                            } else {
                                row.style.display = 'none';
                            }
                        });
                        if(!found) alert("Aucun dossier trouvé pour : " + recherche);
                    }
                }, 1500); // 1.5 secondes pour être sûr que tout est chargé
            }
        });
    </script>
