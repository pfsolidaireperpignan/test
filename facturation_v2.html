// --- GESTION DÉPENSES V13.1 (REF + DATES MULTIPLES) ---
    window.ajouterDepense = async function() {
        const dateFac = document.getElementById('dep_date_fac').value;
        const ref = document.getElementById('dep_ref').value || "Non spécifié"; // Nouveau champ
        const fourn = document.getElementById('dep_fourn').value;
        const dateReg = document.getElementById('dep_date_reg').value; // Nouveau champ
        const cat = document.getElementById('dep_cat').value;
        const mode = document.getElementById('dep_mode').value;
        const statut = document.getElementById('dep_statut').value;
        const mont = parseFloat(document.getElementById('dep_montant').value);

        if(!dateFac || !fourn || isNaN(mont) || cat === "-- Choisir --") {
            return alert("Veuillez remplir : Date Facture, Fournisseur, Catégorie et Montant.");
        }

        try {
            await addDoc(collection(db, "depenses"), {
                date: dateFac,          // On garde 'date' pour le tri principal
                date_reglement: dateReg,// Nouvelle date
                reference: ref,         // Nouvelle réf
                fournisseur: fourn, 
                categorie: cat, 
                mode: mode, 
                statut: statut,
                montant: mont, 
                date_ajout: new Date().toISOString()
            });
            
            // Reset des champs principaux
            document.getElementById('dep_ref').value = "";
            document.getElementById('dep_fourn').value = "";
            document.getElementById('dep_montant').value = "";
            window.chargerDepenses(); 
        } catch(e) { alert("Erreur : " + e.message); }
    };

    window.chargerDepenses = async function() {
        const tbody = document.getElementById('depenses-body');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">Chargement...</td></tr>';
        
        try {
            const q = query(collection(db, "depenses"), orderBy("date", "desc"));
            const snap = await getDocs(q);
            tbody.innerHTML = "";
            global_Depenses = 0; 

            if(snap.empty) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#888;">Aucune dépense.</td></tr>'; updateFinancialDashboard(); return; }

            snap.forEach(docSnap => {
                const data = docSnap.data();
                const dDate = new Date(data.date);
                
                // Calcul financier (Seulement si Réglé et année en cours)
                if(dDate.getFullYear() === currentYear && data.statut === 'Réglé') {
                    global_Depenses += (data.montant || 0);
                }

                // Gestion des badges
                let badgeStatut = '';
                if(data.statut === 'Réglé') {
                    badgeStatut = `<span class="badge badge-regle"><i class="fas fa-check"></i> Réglé</span>`;
                } else {
                    badgeStatut = `<span class="badge badge-attente" onclick="window.marquerCommeRegle('${docSnap.id}')" title="Valider paiement"><i class="fas fa-clock"></i> En attente</span>`;
                }

                // Affichage des deux dates si disponibles
                let dateDisplay = `<b>Fac:</b> ${dDate.toLocaleDateString()}`;
                if(data.date_reglement) {
                    const dReg = new Date(data.date_reglement);
                    dateDisplay += `<br><small style="color:#166534;"><b>Rég:</b> ${dReg.toLocaleDateString()}</small>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-size:0.85rem;">${dateDisplay}</td>
                    <td><span style="font-family:monospace; background:#f1f5f9; padding:2px 5px; border-radius:4px;">${data.reference || '-'}</span></td>
                    <td><strong>${data.fournisseur}</strong></td>
                    <td><span class="badge badge-depense" style="background:#fff; border:none; color:#64748b; font-weight:normal;">${data.categorie}</span></td>
                    <td><span class="badge badge-mode">${data.mode || '-'}</span></td>
                    <td>${badgeStatut}</td>
                    <td style="text-align:right; font-weight:bold; color:#b91c1c;">- ${parseFloat(data.montant).toFixed(2)} €</td>
                    <td style="text-align:center;"><i class="fas fa-trash" style="color:#ef4444; cursor:pointer;" onclick="window.supprimerDepense('${docSnap.id}')"></i></td>
                `;
                tbody.appendChild(tr);
            });
            updateFinancialDashboard();
        } catch(e) { console.error(e); }
    };
