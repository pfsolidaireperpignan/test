<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PF Solidaire - Facturation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- STYLE GLOBAL (COPIE EXACTE DE INDEX.HTML V15) --- */
        :root { --primary: #10b981; --primary-dark: #059669; --secondary: #3b82f6; --dark: #1e293b; --light: #f8fafc; --gray: #64748b; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; margin: 0; display: flex; height: 100vh; color: var(--dark); overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.02); z-index: 10; transition: transform 0.3s ease; }
        .brand { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .nav-menu { list-style: none; padding: 0; margin: 0; flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-radius: 8px; text-decoration: none; color: var(--gray); font-weight: 500; transition: all 0.2s ease; }
        .nav-link:hover, .nav-link.active { background: #ecfdf5; color: var(--primary-dark); transform: translateX(3px); }
        .nav-link i { width: 20px; text-align: center; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #f1f5f9; }
        .hidden { display: none !important; }
        
        /* COMPOSANTS */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap:wrap; gap:15px; }
        h1 { font-size: 1.8rem; font-weight: 700; color: var(--dark); margin: 0; letter-spacing: -0.5px; }
        
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border); }
        h3 { font-size: 0.95rem; font-weight: 700; text-transform: uppercase; color: var(--gray); margin-bottom: 15px; border-bottom: 2px solid var(--light); padding-bottom: 8px; }

        /* FORMULAIRES & TABLEAUX */
        input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; background: #f8fafc; box-sizing: border-box; }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: white; }

        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; color:white; }
        .btn:hover { filter: brightness(105%); transform: translateY(-1px); }
        .btn-green { background: var(--primary); }
        .btn-blue { background: var(--secondary); }
        .btn-red { background: #ef4444; }
        .btn-icon { background: white; border: 1px solid var(--border); padding: 8px; border-radius: 6px; cursor: pointer; color: var(--gray); }

        .history-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .history-table th { text-align: left; padding: 15px; color: var(--gray); font-size: 0.8rem; text-transform: uppercase; font-weight: 700; border-bottom: 2px solid var(--border); background: #f8fafc; }
        .history-table td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        
        /* SPÉCIFIQUE FACTURATION */
        .facture-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .total-zone { background: #eff6ff; padding: 20px; border-radius: 12px; border: 1px dashed var(--secondary); margin-top: 20px; }
        .total-line { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .grand-total { font-size: 1.4rem; font-weight: 800; color: var(--dark); border-top: 2px solid #bfdbfe; padding-top: 10px; margin-top: 10px; }

        /* MOBILE RESPONSIVE (Même code que index.html) */
        #mobile-menu-btn { display: none; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; transform: translateX(-100%); z-index: 5000; }
            .sidebar.mobile-open { transform: translateX(0); }
            #mobile-menu-btn { display: flex !important; position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; background: var(--primary); color: white; border-radius: 50%; border: none; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); z-index: 6000; }
            .main-content { padding: 15px; }
            .facture-grid { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .page-header div { width: 100%; display: flex; gap: 10px; }
            .page-header button { flex: 1; }
            .card { overflow-x: auto; }
        }
    </style>
</head>
<body>
    <img id="logo-source" src="Logo.png" style="display: none;" crossorigin="anonymous">

    <nav class="sidebar">
        <div class="brand"><i class="fas fa-dove"></i> PF ERP <span style="font-size:0.7em; color:var(--gray); margin-left:auto;">Compta</span></div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="index.html" class="nav-link"><i class="fas fa-arrow-left"></i> Retour Accueil</a></li>
            <li class="nav-item"><a href="#" onclick="location.reload()" class="nav-link active"><i class="fas fa-file-invoice-dollar"></i> Facturation</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <div>
                <h1>Facturation</h1>
                <p style="color:var(--gray); margin:0;">Création de devis et factures</p>
            </div>
            <div>
                <button onclick="window.exporterExcel()" class="btn btn-green">
                    <i class="fas fa-file-excel"></i> EXPORT EXCEL
                </button>
            </div>
        </div>

        <div class="facture-grid">
            <div class="card">
                <h3><i class="fas fa-list"></i> Prestations & Articles</h3>
                <div style="overflow-x:auto;">
                    <table class="history-table" id="table-lignes">
                        <thead>
                            <tr>
                                <th style="width:45%">Désignation</th>
                                <th style="width:15%">Qté</th>
                                <th style="width:15%">Prix U.</th>
                                <th style="width:15%">TVA</th>
                                <th style="width:10%">Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tbody-lignes">
                            </tbody>
                    </table>
                </div>
                <button onclick="window.ajouterLigne()" class="btn btn-blue" style="margin-top:15px; width:100%; justify-content:center;">
                    <i class="fas fa-plus"></i> Ajouter une ligne
                </button>
            </div>

            <div class="card">
                <h3><i class="fas fa-user-tie"></i> Client & Dossier</h3>
                
                <label>Importer depuis Dossier</label>
                <select id="select-dossier" onchange="window.remplirClient()" style="margin-bottom:15px;">
                    <option value="">-- Sélectionner --</option>
                </select>

                <label>Client (Facturé à)</label>
                <input id="cli_nom" placeholder="Nom Prénom / Société" style="margin-bottom:10px;">
                <input id="cli_adresse" placeholder="Adresse complète" style="margin-bottom:15px;">

                <label>Défunt (Concerne)</label>
                <input id="defunt_nom" placeholder="Nom du défunt" style="margin-bottom:15px;">

                <div class="total-zone">
                    <div class="total-line"><span>Total HT</span><span id="txt-ht">0.00 €</span></div>
                    <div class="total-line"><span>Total TVA</span><span id="txt-tva">0.00 €</span></div>
                    <div class="total-line grand-total"><span>NET À PAYER</span><span id="txt-ttc">0.00 €</span></div>
                </div>

                <button onclick="window.saveFacture()" class="btn btn-green" style="width:100%; margin-top:20px; justify-content:center; padding:15px;">
                    <i class="fas fa-save"></i> ENREGISTRER & PDF
                </button>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h3><i class="fas fa-history"></i> Historique des Factures</h3>
            <div style="overflow-x:auto;">
                <table class="history-table">
                    <thead><tr><th>N° Facture</th><th>Date</th><th>Client</th><th>Défunt</th><th style="text-align:right;">Montant TTC</th><th style="text-align:center;">Actions</th></tr></thead>
                    <tbody id="historique-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <button id="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fas fa-bars"></i></button>
    <div id="mobile-overlay" onclick="toggleMobileMenu()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:4000;"></div>

    <script type="module">
        import { db, collection, addDoc, getDocs, query, orderBy, doc, deleteDoc } from "./js/config.js";

        // Globales
        window.lignesFacture = [];
        window.dossiersCache = [];

        // 1. INITIALISATION
        window.addEventListener('DOMContentLoaded', async () => {
            await chargerDossiersDropdown();
            await chargerHistorique();
            window.ajouterLigne(); // Ligne vide par défaut
        });

        // 2. GESTION DES LIGNES
        window.ajouterLigne = function() {
            const tbody = document.getElementById('tbody-lignes');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="l-nom" placeholder="Description..." oninput="window.calculTotaux()"></td>
                <td><input type="number" class="l-qte" value="1" oninput="window.calculTotaux()"></td>
                <td><input type="number" class="l-prix" value="0" oninput="window.calculTotaux()"></td>
                <td>
                    <select class="l-tva" onchange="window.calculTotaux()">
                        <option value="20">20%</option>
                        <option value="10">10%</option>
                        <option value="0">0%</option>
                    </select>
                </td>
                <td class="l-total" style="font-weight:bold; text-align:right;">0.00</td>
                <td style="text-align:center;"><button onclick="this.closest('tr').remove(); window.calculTotaux()" style="color:#ef4444; background:none; border:none; cursor:pointer;"><i class="fas fa-times"></i></button></td>
            `;
            tbody.appendChild(tr);
        };

        window.calculTotaux = function() {
            let totalHT = 0;
            let totalTVA = 0;
            window.lignesFacture = []; // Reset

            document.querySelectorAll('#tbody-lignes tr').forEach(row => {
                const nom = row.querySelector('.l-nom').value;
                const qte = parseFloat(row.querySelector('.l-qte').value) || 0;
                const prix = parseFloat(row.querySelector('.l-prix').value) || 0;
                const tvaRate = parseFloat(row.querySelector('.l-tva').value) || 0;
                
                const rowHT = qte * prix;
                const rowTVA = rowHT * (tvaRate / 100);
                
                row.querySelector('.l-total').innerText = (rowHT + rowTVA).toFixed(2);
                
                if(nom) {
                    window.lignesFacture.push({ nom, qte, prix, tva: tvaRate, total: rowHT + rowTVA });
                    totalHT += rowHT;
                    totalTVA += rowTVA;
                }
            });

            document.getElementById('txt-ht').innerText = totalHT.toFixed(2) + " €";
            document.getElementById('txt-tva').innerText = totalTVA.toFixed(2) + " €";
            document.getElementById('txt-ttc').innerText = (totalHT + totalTVA).toFixed(2) + " €";
        };

        // 3. DONNÉES DOSSIERS
        async function chargerDossiersDropdown() {
            const sel = document.getElementById('select-dossier');
            try {
                const q = query(collection(db, "dossiers_admin"), orderBy("date_creation", "desc"));
                const snap = await getDocs(q);
                window.dossiersCache = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    window.dossiersCache.push(d);
                    const opt = document.createElement('option');
                    opt.value = window.dossiersCache.length - 1;
                    opt.text = `${d.mandant?.nom || 'Client'} (Déf: ${d.defunt?.nom || '?'})`;
                    sel.appendChild(opt);
                });
            } catch(e) { console.error(e); }
        }

        window.remplirClient = function() {
            const idx = document.getElementById('select-dossier').value;
            if(idx !== "") {
                const d = window.dossiersCache[idx];
                document.getElementById('cli_nom').value = (d.mandant?.civility||"") + " " + (d.mandant?.nom||"");
                document.getElementById('cli_adresse').value = d.mandant?.adresse || "";
                document.getElementById('defunt_nom').value = (d.defunt?.nom || "") + " " + (d.defunt?.prenom || "");
            }
        }

        // 4. SAUVEGARDE
        window.saveFacture = async function() {
            const client = document.getElementById('cli_nom').value;
            if(!client || window.lignesFacture.length === 0) return alert("Veuillez remplir le client et ajouter des prestations.");
            if(!confirm("Valider cette facture ?")) return;

            const ht = parseFloat(document.getElementById('txt-ht').innerText);
            const tva = parseFloat(document.getElementById('txt-tva').innerText);
            const ttc = parseFloat(document.getElementById('txt-ttc').innerText);
            const num = "F-" + new Date().getFullYear() + "-" + Math.floor(Math.random() * 10000);

            const factureData = {
                numero: num,
                date_creation: new Date().toISOString(),
                client: { nom: client, adresse: document.getElementById('cli_adresse').value },
                defunt: { nom: document.getElementById('defunt_nom').value },
                lignes: window.lignesFacture,
                total_ht: ht, total_tva: tva, total_ttc: ttc,
                statut: "Émise"
            };

            try {
                await addDoc(collection(db, "factures_v2"), factureData);
                genererPDF(factureData);
                alert("✅ Facture sauvegardée !");
                window.location.reload();
            } catch(e) { alert("Erreur : " + e.message); }
        };

        // 5. PDF
        function genererPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18); doc.text("FACTURE " + data.numero, 150, 20);
            doc.setFontSize(12); doc.text("PF SOLIDAIRE", 20, 20);
            doc.setFontSize(10); doc.text("32 Bd Léon Jean Grégory, Thuir", 20, 25);
            
            doc.text("CLIENT :", 120, 50);
            doc.setFont("helvetica", "bold"); doc.text(data.client.nom, 120, 55);
            doc.setFont("helvetica", "normal"); doc.text(data.client.adresse || "", 120, 60);

            const rows = data.lignes.map(l => [l.nom, l.qte, l.prix.toFixed(2), l.tva+"%", l.total.toFixed(2)]);
            doc.autoTable({ startY: 80, head: [['Désignation', 'Qté', 'PU', 'TVA', 'Total TTC']], body: rows });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total HT : ${data.total_ht.toFixed(2)} €`, 150, finalY);
            doc.text(`Total TVA : ${data.total_tva.toFixed(2)} €`, 150, finalY + 7);
            doc.setFont("helvetica", "bold"); doc.text(`NET À PAYER : ${data.total_ttc.toFixed(2)} €`, 130, finalY + 15);

            doc.save(`Facture_${data.numero}.pdf`);
        }

        // 6. HISTORIQUE
        async function chargerHistorique() {
            const tbody = document.getElementById('historique-body');
            const q = query(collection(db, "factures_v2"), orderBy("date_creation", "desc"));
            const snap = await getDocs(q);
            
            snap.forEach(docSnap => {
                const d = docSnap.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${d.numero}</strong></td>
                    <td>${new Date(d.date_creation).toLocaleDateString()}</td>
                    <td>${d.client.nom}</td>
                    <td>${d.defunt?.nom || '-'}</td>
                    <td style="text-align:right; font-weight:bold;">${d.total_ttc.toFixed(2)} €</td>
                    <td style="text-align:center;">
                        <button class="btn-icon" style="color:#ef4444;" onclick="window.supprimerFacture('${docSnap.id}')"><i class="fas fa-trash"></i></button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        window.supprimerFacture = async function(id) {
            if(confirm("Supprimer cette facture ?")) {
                await deleteDoc(doc(db, "factures_v2", id));
                window.location.reload();
            }
        }

        // 7. EXPORT EXCEL (V16)
        window.exporterExcel = async function() {
            if(!confirm("Télécharger le journal des ventes (CSV) ?")) return;
            let csv = "NUMERO;DATE;CLIENT;DEFUNT;TOTAL HT;TVA;TOTAL TTC;STATUT\n";
            try {
                const q = query(collection(db, "factures_v2"), orderBy("numero", "desc"));
                const snap = await getDocs(q);
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = new Date(d.date_creation).toLocaleDateString();
                    const ht = (d.total_ht || 0).toFixed(2).replace('.', ',');
                    const tva = (d.total_tva || 0).toFixed(2).replace('.', ',');
                    const ttc = (d.total_ttc || 0).toFixed(2).replace('.', ',');
                    csv += `${d.numero};${date};${d.client.nom};${d.defunt?.nom||''};${ht};${tva};${ttc};${d.statut||'Emise'}\n`;
                });
                const link = document.createElement("a");
                link.href = 'data:text/csv;charset=utf-8,%EF%BB%BF' + encodeURI(csv);
                link.download = "Journal_Ventes.csv";
                link.click();
            } catch(e) { alert("Erreur export : " + e.message); }
        };

        // 8. MENU MOBILE
        window.toggleMobileMenu = function() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.style.display = sidebar.classList.contains('mobile-open') ? 'block' : 'none';
        };
    </script>
</body>
</html>
