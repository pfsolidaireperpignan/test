<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PF Solidaire - ERP V17 (Menu R√©tractable)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #10b981; --primary-dark: #059669; --secondary: #3b82f6; --dark: #1e293b; --light: #f8fafc; --gray: #64748b; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; margin: 0; display: flex; height: 100vh; color: var(--dark); overflow: hidden; }
        
        /* --- SIDEBAR (MENU GAUCHE) --- */
        .sidebar { 
            width: 260px; 
            background: white; 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.02); 
            z-index: 10; 
            transition: all 0.3s ease; /* Animation fluide */
        }

        /* --- MODE R√âDUIT (COLLAPSED) --- */
        .sidebar.collapsed { width: 80px; padding: 20px 10px; }
        .sidebar.collapsed .brand-text { display: none; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar.collapsed .brand { justify-content: center; }
        .sidebar.collapsed .nav-link { justify-content: center; padding: 15px; }
        .sidebar.collapsed .nav-link i { margin: 0; font-size: 1.4rem; }
        .sidebar.collapsed #btn-toggle-menu { margin-left: 0; }

        /* BRAND */
        .brand { 
            font-size: 1.4rem; font-weight: 800; color: var(--primary); margin-bottom: 40px; 
            display: flex; align-items: center; gap: 10px; white-space: nowrap; overflow: hidden;
        }
        
        /* NAVIGATION */
        .nav-menu { list-style: none; padding: 0; margin: 0; flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-radius: 8px; text-decoration: none; color: var(--gray); font-weight: 500; transition: all 0.2s ease; white-space: nowrap; overflow: hidden; }
        .nav-link:hover, .nav-link.active { background: #ecfdf5; color: var(--primary-dark); transform: translateX(3px); }
        .sidebar.collapsed .nav-link:hover { transform: none; background: #ecfdf5; } /* Pas de d√©calage en mode r√©duit */
        .nav-link i { width: 25px; text-align: center; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #f1f5f9; transition: all 0.3s ease; }
        .hidden { display: none !important; }
        
        /* COMPOSANTS */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1 { font-size: 1.8rem; font-weight: 700; color: var(--dark); margin: 0; letter-spacing: -0.5px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid var(--border); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        h3 { font-size: 0.95rem; font-weight: 700; text-transform: uppercase; color: var(--gray); margin-bottom: 15px; letter-spacing: 0.5px; border-bottom: 2px solid var(--light); padding-bottom: 8px; }

        /* FORMULAIRES */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .span-2 { grid-column: span 2; }
        label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--gray); margin-bottom: 6px; }
        input, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: 'Inter', sans-serif; transition: all 0.2s; background: #f8fafc; box-sizing: border-box; }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }

        /* BOUTONS */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn:hover { filter: brightness(105%); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .btn-green { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .btn-red { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-icon { background: white; border: 1px solid var(--border); padding: 8px; border-radius: 6px; cursor: pointer; color: var(--gray); transition: all 0.2s; }
        .btn-icon:hover { background: var(--light); color: var(--primary); border-color: var(--primary); }

        /* ONGLETS (TABS) */
        .tabs-container { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 2px; }
        .tab-btn { padding: 12px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; font-weight: 600; color: var(--gray); cursor: pointer; font-size: 1rem; transition: all 0.3s; }
        .tab-btn:hover { color: var(--secondary); background: #f8fafc; }
        .tab-btn.active { color: var(--secondary); border-bottom: 3px solid var(--secondary); background: white; }
        .tab-btn i { margin-right: 8px; }

        /* TABLEAU */
        .history-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .history-table th { text-align: left; padding: 15px; color: var(--gray); font-size: 0.8rem; text-transform: uppercase; font-weight: 700; border-bottom: 2px solid var(--border); background: #f8fafc; }
        .history-table td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .history-table tr:hover td { background: #f8fafc; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; background: #ecfdf5; color: var(--primary-dark); border: 1px solid #a7f3d0; }
        .stock-alert { color: #ef4444; font-weight: bold; background: #fee2e2; border: 1px solid #fecaca; }
        .stock-ok { color: #10b981; font-weight: bold; background: #d1fae5; border: 1px solid #a7f3d0; }

        /* LOGIN */
        #login-screen { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); }
        
        /* TABLEAU DE BORD */
        .welcome-banner { background: linear-gradient(135deg, var(--dark) 0%, #334155 100%); color: white; padding: 30px; border-radius: 16px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 25px -5px rgba(30, 41, 59, 0.2); }
        .welcome-text h2 { margin: 0; font-size: 1.8rem; font-weight: 700; color:white; }
        .welcome-text p { margin: 5px 0 0 0; opacity: 0.8; font-size: 0.95rem; }
        .date-badge { background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 12px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); text-align: right; }
        .date-badge div:first-child { font-size: 1.2rem; font-weight: bold; }
        .date-badge div:last-child { font-size: 0.8rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .action-card { background: white; border-radius: 16px; padding: 25px; border: 1px solid var(--border); transition: all 0.3s ease; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; height: 160px; position: relative; overflow: hidden; }
        .action-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); border-color: transparent; }
        .action-card::after { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4)); opacity: 0; transition: 0.5s; }
        .action-card:hover::after { opacity: 1; right: 100%; }

        .card-icon-bg { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 15px; }
        .ac-blue .card-icon-bg { background: #eff6ff; color: var(--secondary); } .ac-blue:hover { border-bottom: 4px solid var(--secondary); }
        .ac-green .card-icon-bg { background: #ecfdf5; color: var(--primary); } .ac-green:hover { border-bottom: 4px solid var(--primary); }
        .ac-purple .card-icon-bg { background: #f5f3ff; color: #8b5cf6; } .ac-purple:hover { border-bottom: 4px solid #8b5cf6; }
        .ac-orange .card-icon-bg { background: #fff7ed; color: #ea580c; } .ac-orange:hover { border-bottom: 4px solid #ea580c; }

        .card-title { font-size: 1.1rem; font-weight: 700; color: var(--dark); margin-bottom: 5px; }
        .card-desc { font-size: 0.85rem; color: var(--gray); }
        .card-arrow { margin-top: auto; text-align: right; color: var(--gray); font-size: 0.9rem; }

        .quick-stats { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .mini-stat { flex: 1; background: white; padding: 15px 20px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; cursor: pointer; transition: transform 0.2s; }
        .mini-stat:hover { transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .mini-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; }

        /* --- STYLE MOBILE (UNIQUEMENT SUR T√âL√âPHONE) --- */
        #mobile-menu-btn { display: none; } /* Cach√© sur PC par d√©faut (on utilise celui dans la sidebar) */

        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; transform: translateX(-100%); transition: transform 0.3s ease; z-index: 5000; width: 85%; }
            .sidebar.mobile-open { transform: translateX(0); }
            /* Cacher le bouton "R√©duire" sur mobile car inutile */
            #btn-toggle-menu { display: none !important; }
            
            #mobile-menu-btn { display: flex !important; align-items: center; justify-content: center; position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; background: var(--primary); color: white; border-radius: 50%; border: none; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); z-index: 6000; cursor: pointer; }
            .main-content { padding: 15px; width: 100%; box-sizing: border-box; }
            .welcome-banner { flex-direction: column; text-align: center; gap: 15px; }
            .date-badge { width: 100%; text-align: center; }
            .form-grid, .form-grid-layout, .dashboard-grid { grid-template-columns: 1fr !important; gap: 10px; }
            .span-2 { grid-column: span 1 !important; }
            .card { overflow-x: auto; }
            .page-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .page-header div { width: 100%; display: flex; flex-wrap: wrap; }
            .page-header button { flex: 1; }
        }
    </style>
</head>
<body>
    <img id="logo-source" src="Logo.png" style="display: none;" crossorigin="anonymous">
    
    <datalist id="villes_list">
        <option value="Perpignan"><option value="Thuir"><option value="Toulouse"><option value="Montpellier"><option value="Paris"><option value="Marseille"><option value="Lyon">
        <option value="Casablanca"><option value="Rabat"><option value="Tanger"><option value="F√®s"><option value="Marrakech"><option value="Oujda"><option value="Nador">
        <option value="Alger"><option value="Oran"><option value="Constantine"><option value="Annaba"><option value="Tlemcen"><option value="B√©ja√Øa">
    </datalist>
    <datalist id="liens_list"><option value="Fils"><option value="Fille"><option value="√âpoux"><option value="√âpouse"><option value="P√®re"><option value="M√®re"><option value="Fr√®re"><option value="S≈ìur"></datalist>

    <div id="app-loader" style="position:fixed; inset:0; background:white; z-index:9999; display:flex; justify-content:center; align-items:center;">
        <i class="fas fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary);"></i>
    </div>

    <div id="login-screen" class="hidden" style="position:fixed; inset:0; z-index:9000; display:flex; justify-content:center; align-items:center;">
        <div class="card" style="width:100%; max-width:400px; text-align:center; padding:50px;">
            <img src="Logo.png" alt="Logo" style="width:120px; margin-bottom:20px;">
            <h2 style="margin-bottom:10px; color:var(--dark);">PF SOLIDAIRE</h2>
            <p style="color:var(--gray); margin-bottom:30px;">Espace de gestion s√©curis√©</p>
            <input type="email" id="login-email" placeholder="Email" style="margin-bottom:15px;">
            <input type="password" id="login-password" placeholder="Mot de passe" style="margin-bottom:25px;">
            <button id="btn-login" class="btn btn-green" style="width:100%; justify-content:center; padding:12px;">SE CONNECTER</button>
            <div style="margin-top:20px;">
                <a href="#" id="btn-forgot" style="color:var(--secondary); font-size:0.9rem; text-decoration:none; font-weight:500;">Mot de passe oubli√© ?</a>
            </div>
        </div>
    </div>

    <nav class="sidebar">
        <div class="brand">
            <i class="fas fa-dove"></i> 
            <span class="brand-text">PF ERP</span> 
            <span style="font-size:0.5em; color:var(--gray); font-weight:400; margin-left:5px;" class="brand-text">v17</span>
            <button id="btn-toggle-menu" onclick="toggleSidebar()" style="margin-left:auto; border:none; background:transparent; cursor:pointer; color:var(--gray);">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="#" onclick="window.showSection('home')" class="nav-link active"><i class="fas fa-home"></i> <span class="nav-text">Accueil</span></a></li>
            <li class="nav-item"><a href="#" onclick="window.showSection('admin')" class="nav-link"><i class="fas fa-folder-open"></i> <span class="nav-text">Dossier Admin</span></a></li>
            <li class="nav-item"><a href="#" onclick="window.showSection('base')" class="nav-link"><i class="fas fa-users"></i> <span class="nav-text">Base Clients</span></a></li>
            <li class="nav-item"><a href="#" onclick="window.showSection('stock')" class="nav-link"><i class="fas fa-boxes"></i> <span class="nav-text">Gestion Stock</span></a></li>
            <li class="nav-item"><a href="facturation_v2.html" class="nav-link"><i class="fas fa-file-invoice-dollar"></i> <span class="nav-text">Facturation</span></a></li>
            <li class="nav-item" style="margin-top:auto;"><a href="#" id="btn-logout" class="nav-link" style="color:#ef4444;"><i class="fas fa-power-off"></i> <span class="nav-text">D√©connexion</span></a></li>
        </ul>
    </nav>

    <main class="main-content">
        <div id="view-home">
            <div class="welcome-banner">
                <div class="welcome-text">
                    <h2>Bonjour, Mustapha üëã</h2>
                    <p>Bienvenue sur votre espace de gestion PF Solidaire.</p>
                </div>
                <div class="date-badge">
                    <div id="header-time">--:--</div>
                    <div id="header-date">Chargement...</div>
                </div>
            </div>

            <div class="quick-stats">
                <div class="mini-stat" onclick="window.showSection('stock')">
                    <div class="mini-icon" style="background:#fff7ed; color:#ea580c;"><i class="fas fa-exclamation-triangle"></i></div>
                    <div><div style="font-size:0.8rem; color:#64748b; font-weight:600;">URGENCES</div><div style="font-weight:bold;">Voir Stocks</div></div>
                </div>
                <div class="mini-stat" onclick="window.showSection('base')">
                    <div class="mini-icon" style="background:#eff6ff; color:#3b82f6;"><i class="fas fa-folder-open"></i></div>
                    <div><div style="font-size:0.8rem; color:#64748b; font-weight:600;">EN COURS</div><div style="font-weight:bold;">Suivi Dossiers</div></div>
                </div>
                <div class="mini-stat" onclick="window.location.reload()">
                    <div class="mini-icon" style="background:#f0fdf4; color:#16a34a;"><i class="fas fa-check-circle"></i></div>
                    <div><div style="font-size:0.8rem; color:#64748b; font-weight:600;">SYST√àME</div><div style="font-weight:bold;">Actualiser</div></div>
                </div>
            </div>

            <h3 style="margin-bottom:20px; font-size:1.1rem; color:var(--dark);">ACC√àS RAPIDE</h3>
            <div class="dashboard-grid">
                <div class="action-card ac-blue" onclick="window.showSection('admin')">
                    <div class="card-icon-bg"><i class="fas fa-user-plus"></i></div>
                    <div>
                        <div class="card-title">Nouveau Dossier</div>
                        <div class="card-desc">Cr√©er une inhumation, cr√©mation ou un rapatriement.</div>
                    </div>
                    <div class="card-arrow"><i class="fas fa-arrow-right"></i></div>
                </div>
                <div class="action-card ac-orange" onclick="window.showSection('base')">
                    <div class="card-icon-bg"><i class="fas fa-users"></i></div>
                    <div>
                        <div class="card-title">Base Clients</div>
                        <div class="card-desc">Retrouver un ancien dossier ou un client.</div>
                    </div>
                    <div class="card-arrow"><i class="fas fa-arrow-right"></i></div>
                </div>
                <div class="action-card ac-green" onclick="window.showSection('stock')">
                    <div class="card-icon-bg"><i class="fas fa-boxes"></i></div>
                    <div>
                        <div class="card-title">Gestion Stocks</div>
                        <div class="card-desc">Entr√©es, sorties et v√©rification des disponibilit√©s.</div>
                    </div>
                    <div class="card-arrow"><i class="fas fa-arrow-right"></i></div>
                </div>
                <div class="action-card ac-purple" onclick="window.location.href='facturation_v2.html'">
                    <div class="card-icon-bg"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div>
                        <div class="card-title">Comptabilit√©</div>
                        <div class="card-desc">Devis, Factures et Registre des Achats.</div>
                    </div>
                    <div class="card-arrow"><i class="fas fa-arrow-right"></i></div>
                </div>
            </div>
        </div>

        <div id="view-stock" class="hidden">
            <div class="page-header">
                <h1>Gestion des Stocks</h1>
                <button class="btn btn-green" onclick="window.openAjoutStock()"><i class="fas fa-plus"></i> AJOUTER ARTICLE</button>
            </div>
            <div id="form-stock" class="card hidden" style="border-top: 4px solid var(--primary);">
                <h3>Nouveau Produit</h3>
                <div class="form-grid">
                    <div><label>Nom de l'article</label><input id="st_nom" placeholder="Ex: Cercueil Ch√™ne..."></div>
                    <div><label>Cat√©gorie</label><select id="st_cat"><option>Cercueil</option><option>Urne</option><option>Capiton</option><option>Accessoire</option></select></div>
                    <div><label>Quantit√© Initiale</label><input type="number" id="st_qte" value="1"></div>
                    <div><label>Prix Achat (‚Ç¨)</label><input type="number" id="st_pa" placeholder="0.00"></div>
                    <div><label>Prix Vente (‚Ç¨)</label><input type="number" id="st_pv" placeholder="0.00"></div>
                    <div><label>Fournisseur</label><input id="st_fourn" placeholder="Nom fournisseur"></div>
                </div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button class="btn btn-green" onclick="window.ajouterArticleStock()">VALIDER</button>
                    <button class="btn btn-red" onclick="document.getElementById('form-stock').classList.add('hidden')">ANNULER</button>
                </div>
            </div>
            <div class="card" style="padding:0; overflow:hidden;">
                <table class="history-table">
                    <thead><tr><th>Article</th><th>Cat√©gorie</th><th>Prix Achat</th><th>Prix Vente</th><th>En Stock</th><th>Actions</th></tr></thead>
                    <tbody id="stock-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-base" class="hidden">
            <div class="page-header">
                <h1>Base Clients</h1>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="search-client" placeholder="Rechercher un dossier..." style="width:250px;">
                    <button class="btn btn-blue" onclick="window.chargerBaseClients()"><i class="fas fa-sync"></i> Actualiser</button>
                </div>
            </div>
            <div class="card" style="padding:0; overflow:hidden;">
                <table class="history-table">
                    <thead><tr><th>Date</th><th>D√©funt</th><th>Mandant</th><th>Op√©ration</th><th style="text-align:center;">Actions</th></tr></thead>
                    <tbody id="clients-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-admin" class="hidden">
            <div class="page-header">
                <h1>Dossier Administratif</h1>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-red" onclick="window.viderFormulaire()"><i class="fas fa-trash-alt"></i> NOUVEAU</button>
                    <button class="btn btn-green" id="btn-save-bdd"><i class="fas fa-save"></i> ENREGISTRER</button>
                </div>
            </div>

            <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd; margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:20px;">
                    <div style="width:50px; height:50px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--secondary); font-size:1.5rem;"><i class="fas fa-cloud-download-alt"></i></div>
                    <div style="flex:1;">
                        <label style="color:#0369a1;">IMPORTER DEPUIS LA FACTURATION</label>
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <select id="select-import-client" style="flex:1;"><option value="">Chargement des clients...</option></select>
                            <button class="btn btn-blue" id="btn-import">Importer</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-grid-layout" style="display:grid; grid-template-columns: 2fr 1fr; gap:25px;">
                
                <div style="display:flex; flex-direction:column;">
                    
                    <div class="tabs-container">
                        <button class="tab-btn active" onclick="window.switchAdminTab('identite')" id="tab-btn-identite"><i class="fas fa-users"></i> 1. IDENTIT√â & FAMILLE</button>
                        <button class="tab-btn" onclick="window.switchAdminTab('technique')" id="tab-btn-technique"><i class="fas fa-cogs"></i> 2. TECHNIQUE & OBS√àQUES</button>
                    </div>

                    <div id="tab-content-identite">
                        <input type="hidden" id="dossier_id">
                        <div class="card" style="border-top: 4px solid var(--secondary);">
                            <h3 style="color:var(--secondary);"><i class="fas fa-user-tie"></i> CLIENT / MANDANT</h3>
                            <div class="form-grid">
                                <div class="span-2">
                                    <label>Civilit√© & Nom Pr√©nom</label>
                                    <div style="display:flex; gap:10px;">
                                        <select id="civilite_mandant" style="width:90px;"><option>M.</option><option>Mme</option></select>
                                        <input id="soussigne" placeholder="Nom et Pr√©nom" style="flex:1; font-weight:600;">
                                    </div>
                                </div>
                                <div><label>Lien de parent√©</label><input id="lien" placeholder="S√©lectionnez..." list="liens_list"></div>
                                <div class="span-2"><label>Adresse Compl√®te</label><input id="demeurant" placeholder="Num√©ro, Rue, Code Postal, Ville" list="villes_list"></div>
                            </div>
                        </div>

                        <div class="card" style="border-top: 4px solid var(--dark);">
                            <h3 style="color:var(--dark);"><i class="fas fa-user"></i> IDENTIT√â D√âFUNT</h3>
                            <div class="form-grid">
                                <div>
                                    <label>Civilit√© & Nom</label>
                                    <div style="display:flex; gap:10px;">
                                        <select id="civilite_defunt" style="width:90px;"><option>M.</option><option>Mme</option></select>
                                        <input id="nom" style="font-weight:bold; flex:1;" placeholder="NOM DE FAMILLE">
                                    </div>
                                </div>
                                <div><label>Pr√©nom(s)</label><input id="prenom" style="font-weight:bold;" placeholder="Pr√©noms"></div>
                                <div><label>Nom de Jeune Fille</label><input id="nom_jeune_fille"></div>
                                
                                <div><label>Date D√©c√®s</label><input type="date" id="date_deces"></div>
                                <div><label>Lieu D√©c√®s</label><input id="lieu_deces" list="villes_list"></div>
                                <div><label>Heure D√©c√®s</label><input type="time" id="heure_deces"></div>
                                
                                <div><label>Date Naissance</label><input type="date" id="date_naiss"></div>
                                <div><label>Lieu Naissance</label><input id="lieu_naiss" list="villes_list"></div>
                                <div><label>Nationalit√©</label><input id="nationalite" value="Fran√ßaise"></div>
                                
                                <div class="span-2"><label>Domicile D√©funt</label><input id="adresse_fr" list="villes_list"></div>
                                
                                <div class="span-2" style="margin-top:15px; padding-top:15px; border-top:1px dashed var(--border);"><small style="color:var(--gray); font-weight:700;">FILIATION & SITUATION</small></div>
                                <div><label>P√®re (Nom Pr√©nom)</label><input id="pere"></div>
                                <div><label>M√®re (Nom Pr√©nom)</label><input id="mere"></div>
                                <div><label>Situation Matrimoniale</label><select id="matrimoniale"><option>Mari√©(e)</option><option>Veuf(ve)</option><option>C√©libataire</option><option>Divorc√©(e)</option></select></div>
                                <div><label>Conjoint(e)</label><input id="conjoint"></div>
                                <div class="span-2">
                                    <label>Profession</label>
                                    <div style="display:flex; gap:10px;">
                                        <select id="prof_type" style="width:40%;">
                                            <option value="Sans profession">Sans profession</option>
                                            <option value="Retrait√©(e)">Retrait√©(e)</option>
                                            <option value="Active">Active (Pr√©ciser ->)</option>
                                        </select>
                                        <input id="profession_libelle" placeholder="Ex: Boulanger, Enseignant..." style="width:60%;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-content-technique" class="hidden">
                        <div class="card" style="border-top: 4px solid #f59e0b;">
                            <h3><i class="fas fa-cog"></i> CONFIGURATION OP√âRATION</h3>
                            <select id="prestation" onchange="window.toggleSections()" style="padding:15px; font-weight:bold; font-size:1rem; color:var(--dark); width:100%;">
                                <option value="Inhumation">‚ö∞Ô∏è INHUMATION</option>
                                <option value="Cr√©mation">üî• CR√âMATION</option>
                                <option value="Rapatriement">‚úàÔ∏è RAPATRIEMENT</option>
                                <option value="Exhumation">‚õèÔ∏è EXHUMATION</option>
                            </select>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-wrench"></i> TECHNIQUE & POLICE</h3>
                            <div class="form-grid">
                                <div><label>Mise en Bi√®re (Lieu)</label><input id="lieu_mise_biere" list="villes_list"></div>
                                <div><label>Date Fermeture</label><input type="date" id="date_fermeture"></div>
                                <div><label>V√©hicule</label><input id="immatriculation" value="DA-081-ZQ"></div>
                                <div class="span-2"><label>Type de Pr√©sence</label>
                                    <select id="type_presence_select" onchange="window.togglePolice()">
                                        <option value="famille">Famille pr√©sente</option>
                                        <option value="police">Police (Absence famille)</option>
                                    </select>
                                </div>
                                <div id="police_fields" class="span-2 form-grid hidden" style="background:#fef2f2; padding:15px; border-radius:8px; border:1px solid #fecaca;">
                                    <div><label>Nom & Grade</label><input id="p_nom_grade"></div>
                                    <div><label>Commissariat</label><input id="p_commissariat"></div>
                                </div>
                                <div id="famille_fields" class="span-2 form-grid" style="background:#f0fdf4; padding:15px; border-radius:8px; border:1px solid #bbf7d0;">
                                    <div class="span-2" style="margin-bottom:5px;">
                                        <input type="checkbox" id="copy_mandant" onchange="window.copierMandant()"> 
                                        <label for="copy_mandant" style="font-weight:600; color:var(--primary-dark); cursor:pointer;">C'est le Mandant (Copie auto)</label>
                                    </div>
                                    <div><label>Nom & Pr√©nom T√©moin</label><input id="f_nom_prenom"></div>
                                    <div><label>Lien avec D√©funt</label><input id="f_lien" list="liens_list"></div>
                                </div>

                                <div class="span-2" style="background:var(--light); padding:15px; margin-top:10px; border-radius:8px; border-left: 4px solid #f59e0b;">
                                    <label style="font-weight:bold; color:var(--dark);">TRANSPORT AVANT MISE EN BI√àRE</label>
                                    <div class="form-grid">
                                        <div><label>Lieu D√©part</label><input id="av_lieu_depart" list="villes_list"></div>
                                        <div><label>Lieu Arriv√©e</label><input id="av_lieu_arrivee" list="villes_list"></div>
                                        <div><label>Date D√©p.</label><input type="date" id="av_date_dep"></div>
                                        <div><label>Heure D√©p.</label><input type="time" id="av_heure_dep"></div>
                                        <div><label>Date Arr.</label><input type="date" id="av_date_arr"></div>
                                        <div><label>Heure Arr.</label><input type="time" id="av_heure_arr"></div>
                                    </div>
                                </div>

                                <div class="span-2" style="background:var(--light); padding:15px; margin-top:10px; border-radius:8px; border-left: 4px solid var(--secondary);">
                                    <label style="font-weight:bold; color:var(--dark);">TRANSPORT APR√àS MISE EN BI√àRE</label>
                                    <div class="form-grid">
                                        <div><label>Lieu D√©part</label><input id="ap_lieu_depart" list="villes_list"></div>
                                        <div><label>Lieu Arriv√©e</label><input id="ap_lieu_arrivee" list="villes_list"></div>
                                        <div><label>Date D√©p.</label><input type="date" id="ap_date_dep"></div>
                                        <div><label>Heure D√©p.</label><input type="time" id="ap_heure_dep"></div>
                                        <div><label>Date Arr.</label><input type="date" id="ap_date_arr"></div>
                                        <div><label>Heure Arr.</label><input type="time" id="ap_heure_arr"></div>
                                    </div>
                                </div>

                                <div><label>Fait √† (G√©n√©ral)</label><input id="faita" value="PERPIGNAN" list="villes_list"></div>
                                <div><label>Date Signature</label><input id="dateSignature" type="date"></div>
                            </div>
                        </div>

                        <div class="card specific-block" id="bloc_inhumation">
                            <h3><i class="fas fa-church"></i> D√âTAILS INHUMATION</h3>
                            <div class="form-grid">
                                <div><label>Cimeti√®re</label><input id="cimetiere_nom" list="villes_list"></div>
                                <div><label>Concession N¬∞</label><input id="num_concession"></div>
                                <div><label>Titulaire</label><input id="titulaire_concession"></div>
                                <div><label>Type S√©pulture</label><select id="type_sepulture"><option>Caveau</option><option>Pleine Terre</option></select></div>
                                <div><label>Date Inhumation</label><input type="date" id="date_inhumation"></div>
                                <div><label>Heure</label><input type="time" id="heure_inhumation"></div>
                            </div>
                        </div>

                        <div class="card specific-block hidden" id="bloc_cremation">
                            <h3><i class="fas fa-fire"></i> D√âTAILS CR√âMATION</h3>
                            <div class="form-grid">
                                <div><label>Cr√©matorium</label><input id="crematorium_nom"></div>
                                <div><label>Date Cr√©mation</label><input type="date" id="date_cremation"></div>
                                <div><label>Heure</label><input type="time" id="heure_cremation"></div>
                                <div class="span-2"><label>Destination Cendres</label><input id="destination_cendres"></div>
                            </div>
                        </div>

                        <div class="card specific-block hidden" id="bloc_rapatriement" style="border-top: 4px solid #ef4444;">
                            <h3><i class="fas fa-plane"></i> D√âTAILS RAPATRIEMENT</h3>
                            <div class="form-grid">
                                <div><label>Pays Destination</label><input id="rap_pays" list="villes_list"></div>
                                <div><label>Ville Destination</label><input id="rap_ville" list="villes_list"></div>
                                <div class="span-2" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid var(--border);">
                                    <label style="font-weight:bold; color:var(--dark);"><i class="fas fa-plane-departure"></i> VOL 1 (Principal)</label>
                                    <div class="form-grid">
                                        <div><label>N¬∞ LTA</label><input id="rap_lta"></div>
                                        <div><label>N¬∞ Vol</label><input id="vol1_num"></div>
                                        <div><label>A√©roport D√©part</label><input id="vol1_dep_aero" list="villes_list"></div>
                                        <div><label>A√©roport Arriv√©e</label><input id="vol1_arr_aero" list="villes_list"></div>
                                        <div><label>D√©p. (Date Heure)</label><input id="vol1_dep_time" placeholder="ex: 20/01 √† 14h00"></div>
                                        <div><label>Arr. (Date Heure)</label><input id="vol1_arr_time" placeholder="ex: 20/01 √† 18h30"></div>
                                    </div>
                                    <div style="margin-top:15px;">
                                        <input type="checkbox" id="check_vol2" onchange="window.toggleVol2()"> 
                                        <label for="check_vol2" style="font-weight:600; color:#ef4444; display:inline;">Ajouter un Vol de Correspondance (Vol 2)</label>
                                    </div>
                                </div>
                                <div id="bloc_vol2" class="span-2 form-grid hidden" style="background:#fff1f2; padding:15px; border-radius:8px; border:1px solid #fecaca;">
                                    <div class="span-2"><label style="font-weight:bold;"><i class="fas fa-exchange-alt"></i> VOL 2 (Correspondance)</label></div>
                                    <div><label>N¬∞ Vol 2</label><input id="vol2_num"></div>
                                    <div></div>
                                    <div><label>A√©roport D√©part</label><input id="vol2_dep_aero" list="villes_list"></div>
                                    <div><label>A√©roport Arriv√©e</label><input id="vol2_arr_aero" list="villes_list"></div>
                                    <div><label>D√©p. (Date Heure)</label><input id="vol2_dep_time"></div>
                                    <div><label>Arr. (Date Heure)</label><input id="vol2_arr_time"></div>
                                </div>
                                <div class="span-2" style="background:var(--light); padding:15px; border-radius:8px;">
                                    <label style="font-weight:bold;">Transport Routier (Arriv√©e)</label>
                                    <div class="form-grid">
                                        <div><label>V√©hicule</label><input id="rap_immat" value="DA-081-ZQ"></div>
                                        <div><label>Date D√©part Route</label><input id="rap_date_dep_route"></div>
                                        <div><label>Ville D√©part</label><input id="rap_ville_dep" list="villes_list"></div>
                                        <div><label>Ville Arriv√©e</label><input id="rap_ville_arr" list="villes_list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top:20px; border-top: 4px solid #3b82f6;">
                        <h3 style="color:#3b82f6;"><i class="fas fa-paperclip"></i> PI√àCES JOINTES (GED)</h3>
                        <div style="background:#eff6ff; padding:15px; border-radius:8px; border:1px dashed #3b82f6;">
                            <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                                <input type="file" id="ged_input_file" accept="image/*,application/pdf" style="flex:1;">
                                <input type="text" id="ged_file_name" placeholder="Nom (ex: CNI, Devis...)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                <button class="btn btn-blue" onclick="window.ajouterPieceJointe()" type="button">
                                    <i class="fas fa-plus"></i> AJOUTER
                                </button>
                            </div>
                            <small style="color:#64748b; display:block; margin-bottom:10px;">‚ö†Ô∏è Plan B : Images l√©g√®res ou PDF (Max 800 Ko).</small>

                            <div id="liste_pieces_jointes" style="display:flex; flex-direction:column; gap:8px;">
                                <div style="color:#94a3b8; font-style:italic;">Aucun document joint.</div>
                            </div>
                        </div>
                    </div>
                    </div>

                <div class="card" style="height:fit-content; position:sticky; top:20px; border-top: 4px solid var(--primary);">
                    <h3><i class="fas fa-print"></i> DOCUMENTS PDF</h3>
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <button class="btn btn-purple" onclick="window.genererPouvoir()">Pouvoir</button>
                        <button class="btn btn-purple" onclick="window.genererDeclaration()">D√©claration D√©c√®s</button>
                        <button class="btn btn-purple" onclick="window.genererFermeture()">PV Fermeture (Police)</button>
                        <button class="btn btn-purple" onclick="window.genererDemandeFermetureMairie()">Fermeture (Mairie)</button>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-purple" style="flex:1; font-size:0.8rem;" onclick="window.genererTransport('avant')">Transport AVANT</button>
                            <button class="btn btn-purple" style="flex:1; font-size:0.8rem;" onclick="window.genererTransport('apres')">Transport APR√àS</button>
                        </div>
                        <button class="btn btn-blue" id="btn_inhumation" onclick="window.genererDemandeInhumation()">Demande Inhumation</button>
                        <button class="btn btn-blue hidden" id="btn_cremation" onclick="window.genererDemandeCremation()">Demande Cr√©mation</button>
                        <button class="btn btn-red hidden" id="btn_rapatriement" onclick="window.genererDemandeRapatriement()">Rapatriement (Pr√©f)</button>
                        <button class="btn btn-blue" onclick="window.genererDemandeOuverture()">Ouverture S√©pulture</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <button id="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>
    <div id="mobile-overlay" onclick="toggleMobileMenu()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:4000;"></div>
    
    <script type="module" src="js/script.js"></script>
    
    <script>
        // --- 1. GESTION DE L'HEURE ---
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
            const dateString = now.toLocaleDateString('fr-FR', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            
            const elTime = document.getElementById('header-time');
            const elDate = document.getElementById('header-date');
            
            if(elTime) elTime.innerText = timeString;
            if(elDate) elDate.innerText = dateString;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- 2. GESTION GED (PLAN B - BASE64) ---
        window.current_pieces_jointes = [];

        window.ajouterPieceJointe = function() {
            const input = document.getElementById('ged_input_file');
            const nameInput = document.getElementById('ged_file_name');
            
            if (input.files.length === 0) return alert("Choisissez un fichier !");
            if (!nameInput.value) return alert("Donnez un nom au document !");
            
            const file = input.files[0];

            if (file.size > 800 * 1024) {
                return alert("‚ö†Ô∏è FICHIER TROP LOURD !\nLa version gratuite limite la taille. Essayez une image plus petite ou un PDF l√©ger.");
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64String = e.target.result;
                if (!window.current_pieces_jointes) window.current_pieces_jointes = [];
                
                window.current_pieces_jointes.push({
                    nom: nameInput.value,
                    type: file.type,
                    data: base64String,
                    date: new Date().toLocaleDateString()
                });

                input.value = "";
                nameInput.value = "";
                window.afficherPiecesJointes();
            };
            reader.readAsDataURL(file);
        };

        window.afficherPiecesJointes = function() {
            const container = document.getElementById('liste_pieces_jointes');
            container.innerHTML = "";

            if (!window.current_pieces_jointes || window.current_pieces_jointes.length === 0) {
                container.innerHTML = '<div style="color:#94a3b8; font-style:italic;">Aucun document joint.</div>';
                return;
            }

            window.current_pieces_jointes.forEach((doc, index) => {
                const div = document.createElement('div');
                div.style = "background:white; padding:10px; border-radius:6px; border:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;";
                
                let icon = doc.type.includes('pdf') ? '<i class="fas fa-file-pdf" style="color:red;"></i>' : '<i class="fas fa-file-image" style="color:blue;"></i>';

                div.innerHTML = `
                    <div style="display:flex; gap:10px; align-items:center;">
                        ${icon} <strong>${doc.nom}</strong> <small>(${doc.date})</small>
                    </div>
                    <div>
                        <button onclick="window.voirDocument(${index})" style="background:#3b82f6; color:white; border:none; padding:5px 10px; border-radius:4px; margin-right:5px; cursor:pointer;"><i class="fas fa-eye"></i></button>
                        <button onclick="window.supprimerDocument(${index})" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        };

        window.voirDocument = function(index) {
            const doc = window.current_pieces_jointes[index];
            const win = window.open();
            win.document.write(`<iframe src="${doc.data}" style="border:0; width:100%; height:100%;" allowfullscreen></iframe>`);
        };

        window.supprimerDocument = function(index) {
            if(confirm("Supprimer ce document ?")) {
                window.current_pieces_jointes.splice(index, 1);
                window.afficherPiecesJointes();
            }
        };

        // --- 3. GESTION MENU MOBILE (BURGER) & SIDEBAR R√âTRACTABLE (PC) ---
        window.toggleSidebar = function() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const btnIcon = document.querySelector('#mobile-menu-btn i');
            
            // Si on est sur mobile
            if (window.innerWidth < 768) {
                sidebar.classList.toggle('mobile-open');
                if (sidebar.classList.contains('mobile-open')) {
                    overlay.style.display = 'block';
                    btnIcon.classList.remove('fa-bars');
                    btnIcon.classList.add('fa-times');
                } else {
                    overlay.style.display = 'none';
                    btnIcon.classList.remove('fa-times');
                    btnIcon.classList.add('fa-bars');
                }
            } else {
                // Si on est sur PC : mode r√©duit
                sidebar.classList.toggle('collapsed');
            }
        };

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if(window.innerWidth < 768) window.toggleSidebar();
            });
        });

        // --- 4. R√âCEPTION DU LIEN FACTURE (RECHERCHE AUTO) ---
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const recherche = params.get('recherche');

            if(recherche) {
                window.showSection('base'); // Ouvre l'onglet "Base Clients"
                
                setTimeout(() => {
                    const input = document.getElementById('search-client');
                    if(input) {
                        input.value = recherche;
                        // D√©clenche l'√©v√©nement "keyup" pour filtrer la liste
                        input.dispatchEvent(new Event('keyup'));
                    }
                }, 1000); // Petit d√©lai pour laisser Firebase charger
            }
        });
    </script>
</body>
</html>
